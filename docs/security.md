# GIM 安全分析文档

> 版本: 0.1.0-beta.1 | 最后更新: 2026-02

## 1. 安全架构概览

### 1.1 安全边界

```
┌───────────────────────────────────────────────────┐
│                  信任边界                          │
│                                                   │
│  ┌───────────┐     ┌────────────────────────┐    │
│  │ 客户端    │     │    GIM 服务端           │    │
│  │ (不可信)  │────→│                        │    │
│  │           │     │  ┌──────────────────┐  │    │
│  └───────────┘     │  │ 认证层           │  │    │
│       ↕            │  │ (Token 验证)     │  │    │
│  ┌───────────┐     │  └────────┬─────────┘  │    │
│  │ 管理员    │     │           ↓            │    │
│  │ (半可信)  │────→│  ┌──────────────────┐  │    │
│  └───────────┘     │  │ 业务逻辑层       │  │    │
│                    │  │ (权限检查)       │  │    │
│                    │  └────────┬─────────┘  │    │
│  ┌───────────┐     │           ↓            │    │
│  │ 上游 OIDC │     │  ┌──────────────────┐  │    │
│  │ (可信)    │←───→│  │ 数据层           │  │    │
│  └───────────┘     │  │ (SQLite + S3)    │  │    │
│                    │  └──────────────────┘  │    │
│                    └────────────────────────┘    │
└───────────────────────────────────────────────────┘
```

### 1.2 安全机制总览

| 层次 | 机制 | 状态 |
|------|------|------|
| 传输层 | HTTPS（需反向代理） | 部分（依赖部署配置） |
| 认证 | OAuth 2.0 + PKCE / Bot Token | ✅ 完整 |
| 授权 | 每路由 authMiddleware + 权限级别检查 | ✅ 基本完整 |
| 输入校验 | Zod schema 验证 | ⚠️ 部分覆盖 |
| 限流 | 滑动窗口 600/min/IP | ✅ 基础实现 |
| E2EE | Olm/Megolm + Ed25519 签名验证 | ✅ 完整 |
| CORS | 可配置来源 | ✅ |
| 日志 | 结构化请求日志 | ✅ |
| 密钥管理 | 环境变量配置 | ⚠️ 无密钥轮换 |

---

## 2. 认证安全分析

### 2.1 OAuth 2.0 / OIDC 流程

**安全特性：**
- PKCE (S256) 用于防止授权码截取攻击
- 授权码一次性使用（consumedAt 标记）
- RefreshToken 轮换机制（使用后标记消费，签发新 token）
- State 参数防 CSRF
- 短 TTL：AuthorizationCode 1 分钟、LoginToken 2 分钟

**已知问题：**

| 编号 | 问题 | 严重性 | 说明 |
|------|------|--------|------|
| AUTH-1 | SSO state 存于进程内存 | 中 | 重启丢失，多进程不一致 |
| AUTH-2 | Token 端点无独立限流 | 中 | 可暴力尝试刷新 token |
| AUTH-3 | 设备 ID scope 未验证 | 低 | Token 中的 device_id 不校验设备是否存在 |
| AUTH-4 | AccessToken 为 JWT 但未验证签名 | 低 | 依赖数据库查询而非 JWT 验证（实际安全，但浪费 JWT） |

### 2.2 Bot Token (AccountToken)

**设计：**
- 长期有效，不过期
- PK 即 token 值本身
- 每次使用更新 lastUsedAt

**风险：**
- 泄露即永久访问（无过期机制）
- 无 scope 限制（完整用户权限）
- 管理面板返回掩码 token，但原始值不可再获取

**建议：**
- 添加可选过期时间
- 添加 scope 限制
- 添加 IP 白名单选项

### 2.3 管理员认证

**当前实现：**
- 使用 AccountToken 认证
- 检查 `accounts.admin` 标志
- Token 存储于 localStorage

**风险：**
| 编号 | 问题 | 严重性 |
|------|------|--------|
| ADMIN-1 | localStorage 中的 token 可被 XSS 窃取 | 中 |
| ADMIN-2 | 无管理操作审计日志 | 中 |
| ADMIN-3 | 管理员权限无细分 | 低 |

---

## 3. 输入验证分析

### 3.1 当前验证覆盖

| 端点类别 | Zod 验证 | 手动验证 | 无验证 |
|---------|---------|---------|--------|
| 房间创建 | ✅ | | |
| 消息发送 | ✅ (eventContent) | | |
| 用户资料 | ✅ (displayName, avatarUrl) | | |
| 设备更新 | ✅ | | |
| 登录 | ✅ | | |
| E2EE 密钥上传 | | ⚠️ 部分 | |
| 管理 API | | | ⚠️ 参数未验证 |
| 状态事件 | ✅ (eventContent) | | |
| 账号数据 | | | ⚠️ content 未验证 |

### 3.2 验证缺口

| 编号 | 问题 | 位置 | 影响 |
|------|------|------|------|
| VAL-1 | 管理 API limit/offset 未校验 | admin/routes.ts | 负值、溢出 |
| VAL-2 | E2EE 签名上传不验证签名有效性 | e2ee/routes.ts | 可注入虚假签名 |
| VAL-3 | createRoomBody 使用 passthrough() | validation.ts | 允许注入任意字段 |
| VAL-4 | 账号数据 content 无 schema 验证 | account/routes.ts | 任意 JSON 存入 |
| VAL-5 | state_key 长度无限制 | message/routes.ts | 潜在 DoS |
| VAL-6 | 房间别名格式验证不严格 | room/routes.ts | 允许特殊字符 |

---

## 4. E2EE 安全分析

### 4.1 密钥管理安全

**正确实现：**
- Ed25519 签名验证使用标准 crypto.verify()
- 身份密钥变更时正确清理所有关联密钥和消息
- OTK 单次使用（claimed 标记后不再分配）
- 备用密钥作为 OTK 耗尽时的兜底

**已知问题：**

| 编号 | 问题 | 严重性 | 说明 |
|------|------|--------|------|
| E2EE-1 | 签名上传端点不验证签名内容 | 中 | 盲目合并签名，可伪造验证状态 |
| E2EE-2 | To-device 消息删除竞态 | 中 | 同步获取后立即删除，客户端崩溃则消息丢失 |
| E2EE-3 | 密钥变更的 pendingKeyChange 竞态 | 低 | 并发上传可能覆盖标志 |
| E2EE-4 | 设备密钥表无 FK 约束 | 低 | 依赖 cron 清理孤儿，有时间窗口 |

### 4.2 To-device 消息安全

**正确实现：**
- auto-increment 保证严格顺序（非 ULID）
- 发送者信息记录在消息中
- lastToDeviceStreamId 追踪消费位置

**风险：**
- 无消息大小限制（潜在 DoS）
- 无发送频率限制（可大量发送 to-device）
- 通配符设备 ID `*` 会发送给所有设备

---

## 5. 媒体安全分析

### 5.1 文件处理

| 编号 | 问题 | 严重性 | 说明 |
|------|------|--------|------|
| MEDIA-1 | 文件名清理不完整 | 中 | 仅去除引号/反斜杠/换行，未处理 null 字节和路径遍历 |
| MEDIA-2 | 预签名上传无内容验证 | 中 | 客户端直传 S3 后，PUT 确认不校验实际文件内容 |
| MEDIA-3 | Content-Type 由客户端指定 | 低 | 不校验实际文件类型 |
| MEDIA-4 | 孤儿 S3 文件 | 低 | 预签名上传后未确认的文件泄漏（无清理机制） |

### 5.2 存储安全

- 本地存储：写入 `data/media/` 目录，无加密
- S3/R2 存储：使用 presigned URL，默认 1 小时有效期
- 下载权限：仅检查 mediaId 存在，不检查访问权限（Matrix 规范行为）

---

## 6. 限流与 DoS 防护

### 6.1 当前限流

| 限流点 | 速率 | 实现方式 |
|--------|------|---------|
| 全局 API | 600/min/IP | 内存滑动窗口 |
| 媒体上传 | 可配置/小时/用户 | 内存 Map |
| 媒体配额 | 可配置 MB/用户 | 数据库 SUM |

### 6.2 缺失限流

| 端点 | 风险 | 建议 |
|------|------|------|
| POST /keys/upload | OTK 大量上传 | 限制每设备 OTK 数量 |
| PUT /sendToDevice | to-device 消息洪泛 | 每分钟/每用户限制 |
| POST /createRoom | 房间创建滥用 | 每用户限制 |
| POST /keys/query | 批量密钥查询 | 每请求用户数量限制 |
| POST /login | 登录尝试 | 每 IP/每账号限制 |
| POST /oauth/token | Token 端点暴力 | 每 IP 限制 |

---

## 7. 权限模型分析

### 7.1 房间权限

- 基于 Matrix power levels 机制
- `requirePowerLevel()` 比较发送者与目标权限级别
- `requireMembership()` 检查房间成员状态

**正确实现：**
- 踢出/封禁需要 sender_power > target_power（严格大于）
- 撤回需要 redact 权限或消息发送者本人
- 房间创建者自动获得最高权限 (100)

**风险：**
- 权限级别查询未缓存，每次操作重新查询
- 无权限变更审计

### 7.2 管理员权限

- 二元模型：admin=true/false
- 无角色细分（无只读管理员、审计员等）
- 管理员可停用任何用户（包括其他管理员）

---

## 8. 安全加固建议

### 8.1 高优先级

1. **管理 Token 改用 httpOnly Cookie**
   - 当前 localStorage 存储易受 XSS 攻击
   - 添加 SameSite=Strict, Secure 属性

2. **添加安全响应头**
   ```
   X-Content-Type-Options: nosniff
   X-Frame-Options: DENY
   Strict-Transport-Security: max-age=63072000
   Content-Security-Policy: default-src 'self'
   ```

3. **签名验证**
   - E2EE 签名上传端点应验证签名内容
   - 拒绝无效签名而非盲目合并

4. **文件名安全处理**
   ```typescript
   // 移除 null 字节
   filename = filename.replace(/\0/g, '')
   // 移除路径分隔符
   filename = filename.replace(/[/\\]/g, '_')
   // 限制长度
   filename = filename.slice(0, 255)
   ```

5. **添加登录限流**
   - POST /login: 5 次/分钟/IP
   - POST /oauth/token: 10 次/分钟/IP

### 8.2 中优先级

6. **审计日志**
   - 记录管理操作（用户停用、权限变更、token 吊销）
   - 记录登录尝试（成功/失败）
   - 持久化到数据库表

7. **To-device 消息保护**
   - 添加消息大小限制
   - 添加每用户发送频率限制
   - 通配符 `*` 设备目标添加限制

8. **管理面板 CSP**
   - 限制脚本执行来源
   - 限制连接来源

### 8.3 低优先级

9. **AccountToken 增强**
   - 可选过期时间
   - IP 白名单
   - Scope 限制

10. **设备自动过期**
    - 长期不活跃设备自动清理
    - 通知用户旧设备被移除

11. **密码认证选项**
    - 为不使用 SSO 的场景提供备选
    - 密码存储使用 Argon2id

---

## 9. 安全检查清单

### 部署安全

- [ ] 设置 `IM_COOKIE_SECRET` 为强随机值
- [ ] 配置 HTTPS（通过反向代理）
- [ ] 限制 `IM_CORS_ORIGINS` 为实际域名
- [ ] S3 bucket 配置私有访问
- [ ] 数据库文件权限限制 (600)
- [ ] 日志不输出敏感信息

### 运行安全

- [ ] 定期审查管理员列表
- [ ] 监控限流触发日志
- [ ] 备份数据库
- [ ] 更新依赖（关注安全公告）
- [ ] 监控磁盘空间（媒体存储、SQLite WAL）

### 代码安全

- [ ] Zod 验证覆盖所有用户输入
- [ ] 数据库操作使用参数化查询（Drizzle ORM 默认安全）
- [ ] 无 SQL 拼接（检查 raw SQL 部分）
- [ ] 文件操作路径验证
- [ ] 密钥/token 不出现在日志中
